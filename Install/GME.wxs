<?xml version='1.0' encoding='windows-1252'?>

<!--

  WiX installer source file for GME.
  Author: Peter Volgyesi <peter.volgyesi@vanderbilt.edu>

  Copyright (c) 2009, Vanderbilt University
  All rights reserved.
  
  Permission to use, copy, modify, and distribute this software and its
  documentation for any purpose, without fee, and without written agreement is
  hereby granted, provided that the above copyright notice, the following
  two paragraphs and the author appear in all copies of this software.
  
  IN NO EVENT SHALL THE VANDERBILT UNIVERSITY BE LIABLE TO ANY PARTY FOR
  DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT
  OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF THE VANDERBILT
  UNIVERSITY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  
  THE VANDERBILT UNIVERSITY SPECIFICALLY DISCLAIMS ANY WARRANTIES,
  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
  ON AN "AS IS" BASIS, AND THE VANDERBILT UNIVERSITY HAS NO OBLIGATION TO
  PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
  
-->

<!--

  General comments:
  
  This file needs to be compiled with the following switches (as of WiX 3.0.4813.0):
  
  candle.exe GME.wxs
  
  light.exe -sw1076 -sw1055 -sw1056 -sice:ICE43 -sice:ICE57 GME.wixobj  -ext WixUIExtension -ext WixUtilExtension
  
  -sw1076 -sw1055 -sw1056: These are needed to supress the warnings coming from the (kosher) VC9 runtime 
                           redistributable merge modules.
                           
  -sice:ICE43 -sice:ICE57: These are needed because of the non-advertised shortcuts. ICEs (wrongly) complain because these
                           shortcuts are in the 'user' profile without user keypaths. Since, ALLUSER is constantly set to
                           '1', the shortcuts will never be in the 'user' profile but will be created machine-wide. 
                           Also, I had problems with advertised shortcuts (icons for pdf and html files), so I decided
                           to disable these consistency checks.
  
  -ext WixUIExtension -ext WixUtilExtension: These are needed for the installer GUI (references to 'stock' WiX plugins)
  
-->

<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi' RequiredVersion='3.0.4813.0'>

  <?include GME_dyn.wxi ?>
  <?include GME_inc.wxi ?>



  <Product Name='$(var.ProductName)' Id='*' UpgradeCode='$(var.UpgradeCode)'
        Language='1033' Codepage='1252' Version='$(var.VERSIONSTR)' Manufacturer='Vanderbilt University, ISIS'>

    <Package Id='*' Keywords='GME, MIC, modeling, domain specific languages' Description='Generic Modeling Environment Installer'
        Manufacturer='Vanderbilt University, ISIS'
        InstallerVersion='300' Languages='1033' Compressed='yes' SummaryCodepage='1252'
        InstallPrivileges='elevated' InstallScope='perMachine'/>


    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion Minimum="$(var.VERSIONSTR)" OnlyDetect="yes" Property="NEWERVERSIONDETECTED"/>
      <UpgradeVersion OnlyDetect="no" Minimum="1.0.0" IncludeMinimum="yes" Maximum="$(var.VERSIONSTR)" IncludeMaximum="no" Property="PREVIOUSFOUND"/>
    </Upgrade>
    <?if $(sys.BUILDARCH)=x64 ?>
    <Upgrade Id="dfdd761e-0979-4897-ac89-71f006d92bf8">
      <UpgradeVersion Minimum="$(var.VERSIONSTR)" OnlyDetect="yes" Property="NEWERVERSIONDETECTED_X86"/>
      <UpgradeVersion OnlyDetect="no" Minimum="1.0.0" IncludeMinimum="yes" Maximum="$(var.VERSIONSTR)" IncludeMaximum="no" Property="PREVIOUSFOUND_X86"/>
    </Upgrade>
    <?endif?>
    <CustomActionRef Id="WixExitEarlyWithSuccess"/>
    <?if $(sys.BUILDARCH)=x64 ?>
    <SetProperty Id="NEWERVERSIONDETECTED" Value="1" After="FindRelatedProducts">NEWERVERSION_DETECTED_X86</SetProperty>
    <InstallExecuteSequence>
      <Custom Action="WixExitEarlyWithSuccess" After="SetNEWERVERSIONDETECTED">NEWERVERSIONDETECTED AND VersionNT &gt; 400</Custom>
    </InstallExecuteSequence>
    <?endif?>

    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallValidate" />
    </InstallExecuteSequence>

    <Media Id='1' Cabinet='GME.cab' EmbedCab='yes' />

    <Condition Message="This application is only supported on Windows XP or higher.">
      <![CDATA[Installed OR (VersionNT >= 501)]]>
    </Condition>

    <Property Id='ARPPRODUCTICON' Value='GME.ico' />

    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch GME" />
    <Property Id="WixShellExecTarget" Value="[#GME.exe]" />
    <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

    <WixVariable Id="WixUILicenseRtf" Value="..\Doc\Legal\License.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" />

    <Icon Id='GME.ico' SourceFile='..\GME\Gme\res\GME.ico' />

    <!-- =========================================================== -->
    <!-- DIRECTORY STRUCTURE -->
    <!-- =========================================================== -->
    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id='$(var.ProgramFilesNativeFolder)'>
        <Directory Id='INSTALLDIR' Name='GME'>
        </Directory>
      </Directory>
    </Directory>

    <!-- =========================================================== -->
    <!-- MERGE MODULES -->
    <!-- =========================================================== -->
    <DirectoryRef Id='TARGETDIR'>
      <?if $(sys.BUILDARCH)=x86 ?>
      <Merge Id="CRT" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC90_CRT_$(sys.BUILDARCH).msm" DiskId="1" />
      <Merge Id="CRT Policy" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\policy_9_0_Microsoft_VC90_CRT_$(sys.BUILDARCH).msm" DiskId="1" />
      <Merge Id="MFC" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC90_MFC_$(sys.BUILDARCH).msm" DiskId="1" />
      <Merge Id="MFC Policy" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\policy_9_0_Microsoft_VC90_MFC_$(sys.BUILDARCH).msm" DiskId="1" />
      <Merge Id="ATL" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC90_ATL_$(sys.BUILDARCH).msm" DiskId="1" />
      <Merge Id="ATL Policy" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\policy_9_0_Microsoft_VC90_ATL_$(sys.BUILDARCH).msm" DiskId="1" />
      <?endif?>
      <Merge Id="CRT100" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC100_CRT_$(sys.BUILDARCH).msm" DiskId="1" />
      <Merge Id="MFC100" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC100_MFC_$(sys.BUILDARCH).msm" DiskId="1" />
      <Merge Id="ATL100" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC100_ATL_$(sys.BUILDARCH).msm" DiskId="1" />

      <Merge Id="GME_bin" Language="1033" SourceFile="GME_bin.msm" DiskId="1" />
      <Merge Id="GME_SDK" Language="1033" SourceFile="GME_SDK.msm" DiskId="1"/>
      <Merge Id="GME_paradigms" Language="1033" SourceFile="GME_paradigms.msm" DiskId="1"/>
      <?if $(sys.BUILDARCH)=x64 ?>
      <Merge Id="GME_bin_x64" Language="1033" SourceFile="GME_bin_x64.msm" DiskId="1" />
      <Merge Id="CRT100_x86" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC100_CRT_x86.msm" DiskId="1" />
      <Merge Id="MFC100_x86" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC100_MFC_x86.msm" DiskId="1" />
      <Merge Id="ATL100_x86" Language="0" SourceFile="$(env.ProgramFiles)\Common Files\Merge Modules\Microsoft_VC100_ATL_x86.msm" DiskId="1" />
      <?endif?>
    </DirectoryRef>


    <!-- =========================================================== -->
    <!-- FEATURES -->
    <!-- =========================================================== -->
    <Feature Id='Complete' Title='Generic Modeling Environment' Description='The complete package' Display='expand' Level='1'
        ConfigurableDirectory='INSTALLDIR'>

      <Feature Id='GMEApplication' Title='GME Application' Description='This feature contains the core modeling framework and the meta environment'
          Level='1'>

        <MergeRef Id='GME_bin' />
        <MergeRef Id='GME_paradigms' />
        <?if $(sys.BUILDARCH)=x64 ?>
        <MergeRef Id='GME_bin_x64'/>
        <MergeRef Id='CRT100_x86' />
        <MergeRef Id='MFC100_x86' />
        <MergeRef Id='ATL100_x86' />
        <?endif?>

        <?if $(sys.BUILDARCH)=x86 ?>
        <MergeRef Id='CRT' />
        <MergeRef Id='CRT Policy' />
        <MergeRef Id='MFC' />
        <MergeRef Id='MFC Policy' />
        <MergeRef Id='ATL' />
        <MergeRef Id='ATL Policy' />
        <?endif?>

        <MergeRef Id='CRT100' />
        <MergeRef Id='MFC100' />
        <MergeRef Id='ATL100' />
      </Feature>

      <Feature Id='Samples' Title='Samples' Description='These are sample paradigms and interpreters with source code'
          Level='1'>
        <MergeRef Id='GME_SDK'/>
      </Feature>
    </Feature>

    <!-- =========================================================== -->
    <!-- USER INTERFACE -->
    <!-- =========================================================== -->
    <UI>
      <UIRef Id="WixUI_Minimal" />
      <UIRef Id="WixUI_ErrorProgressText" />
      <Publish Dialog="ExitDialog"
          Control="Finish"
          Event="DoAction"
          Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
      <InstallUISequence>
        <Show Dialog="UserExit" OnExit="cancel">0</Show>
      </InstallUISequence>
    </UI>

  </Product>
</Wix>
